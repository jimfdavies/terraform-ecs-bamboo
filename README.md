terraform-ecs-bamboo
====================

## Objective
Deploy Atlassian Bamboo Server (standalone) to AWS EC2 Container Service and present License Setup via a IP-restricted Application Load Balancer.
Due to the licensing restrictions on this commercial product, some manual steps are currently needed.
However, once initial setup is complete and the Bamboo config and database is persisted, the service is self-healing after task/instance/AZ loss.

## Features
- Build a VPC over all AZs with public-facing subnets
- Create and deploy ECS instances across those subnets
- Create ECS service and connect EFS
- Deploy Docker image https://hub.docker.com/r/jimfdavies/bamboo-server-alpine/
- Create ALB and register ECS service to Target Group
- Deploy EFS filesystem and attach to all running instances
- Deploy empty PostgresDB instance on RDS
- Output service public IP and RDS endpoint

- TODO: Deploy an ECS Service of Bamboo Agents (registering would be manual post-setup)
- TODO: Deploy automated backup service for config/data
- TODO: Deploy optional 'Bamboo restorer' service that re-hydrates config/data
- TODO: Optionally, use Terraform File provisioner to populate initial config

Takes you as far as the license page when you connect. You will need to add your own license and run the Custom Installation connecting to the RDS instance.
this config will be stored on the EFS volume at /home/bamboo.

## Usage

Plan
```
terraform plan \
  -var 'shared_credentials_file=~/.aws/credentials.personal' \
  -var 'admin_cidr_ingress=1.2.3.4/32' \
  -var 'key_name=bamboo-ecs' \
  -var 'db_username=master' \
  -var 'db_password=changemerightmeow'
```
Apply
```
terraform apply \
  -var 'shared_credentials_file=~/.aws/credentials.personal' \
  -var 'admin_cidr_ingress=1.2.3.4/32' \
  -var 'key_name=bamboo-ecs' \
  -var 'db_username=master' \
  -var 'db_password=changemerightmeow'
```
Destroy
```
terraform destroy \
  -var 'shared_credentials_file=~/.aws/credentials.personal' \
  -var 'admin_cidr_ingress=1.2.3.4/32' \
  -var 'key_name=bamboo-ecs' \
  -var 'db_username=master' \
  -var 'db_password=changemerightmeow'
```

## Bamboo setup

An unattended setup for fresh installations has not yet been implemented and the manual instructions in the GUI are below.

Note: The Server service can take up to three minutes to start up and register with the ALB.

When Apply has finished, follow official [Bamboo Setup Wizard](https://confluence.atlassian.com/bamboo/running-the-setup-wizard-289276851.html) using the Outputs from the Terraform run. Below are the basic steps though.

Server setup:
1. Browse to the 'alb_endpoint' generated by Terraform and displayed as an Output and you should see the License Setup page
2. Enter your license key or use the 'Request a 30-day Bamboo evaluation license' link at the bottom of the page
3. Click the 'Custom installation' button
4. On the 'General configuration' page, in 'Remote agent communication', replace '0.0.0.0' with the Terraform Output 'broker_endpoint'. Click 'Continue'
5. On the 'Database configuration' page, select 'External' and 'PostgreSQL'. Click 'Continue'
6. On the 'Connect to your database' page,
  a. Replace 'Database URL' with the Terraform Output 'database_url'
  b. Add 'User name' with the Terraform Output 'db_username'
  c. Add 'Password' with the Terraform Output 'db_password' (which you provided at runtime)
  d. Click 'Continue'
7. On the 'Select starting data for Bamboo' page, select 'Create a new Bamboo home'
8. On the 'Set up administrator user' page, add the relevant details. Click 'Continue'
9. Your Bamboo Server should now be ready for you to create Build Plans

Agent setup:
1. Click the Bamboo Administration cog in the top-right corner and select Agents
2. (to be completed...)


## Security notes

If you are concerned with security, you may want to consider extending this configuration with these recommendations.

- Add HTTPS (with a genuine DNS domain) to the ALB (use Route 53)
- Add SSL to the Agent communications
- Create a new ECS cluster for the Agents so the instance hosts don't have the EFS share mounted
- Create 'private' subnets and deploy ECS instances to that
